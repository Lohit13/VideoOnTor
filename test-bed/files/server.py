from flask import Flask
import sys, copy
import subprocess, shlex, random
from multiprocessing import Process, Queue

app = Flask(__name__)

cmd = "ffmpeg -re -i original.mp4 -vcodec copy -an -f rtp rtp://xx:5554"
args = shlex.split(cmd)

#all_ips = ['192.168.52.0', '192.168.52.1', '192.168.52.2', '192.168.52.3', '192.168.52.4', '192.168.52.5', '192.168.52.6', '192.168.52.7', '192.168.52.8', '192.168.52.9', '192.168.52.10', '192.168.52.11', '192.168.52.12', '192.168.52.13', '192.168.52.14', '192.168.52.15', '192.168.52.16', '192.168.52.17', '192.168.52.18', '192.168.52.19', '192.168.52.20', '192.168.52.21', '192.168.52.22', '192.168.52.23', '192.168.52.24', '192.168.52.25', '192.168.52.26', '192.168.52.27', '192.168.52.28', '192.168.52.29', '192.168.52.30', '192.168.52.31', '192.168.52.32', '192.168.52.33', '192.168.52.34', '192.168.52.35', '192.168.52.36', '192.168.52.37', '192.168.52.38', '192.168.52.39', '192.168.52.40', '192.168.52.41', '192.168.52.42', '192.168.52.43', '192.168.52.44', '192.168.52.46', '192.168.52.47', '192.168.52.48', '192.168.52.49', '192.168.52.50', '192.168.52.51', '192.168.52.52', '192.168.52.53', '192.168.52.54', '192.168.52.55', '192.168.52.56', '192.168.52.57', '192.168.52.58', '192.168.52.59', '192.168.52.60', '192.168.52.61', '192.168.52.62', '192.168.52.63', '192.168.52.64', '192.168.52.65', '192.168.52.66', '192.168.52.67', '192.168.52.68', '192.168.52.69', '192.168.52.70', '192.168.52.71', '192.168.52.72', '192.168.52.73', '192.168.52.74', '192.168.52.75', '192.168.52.76', '192.168.52.77', '192.168.52.78', '192.168.52.79', '192.168.52.80', '192.168.52.81', '192.168.52.82', '192.168.52.83', '192.168.52.84', '192.168.52.85', '192.168.52.86', '192.168.52.87', '192.168.52.88', '192.168.52.89', '192.168.52.90', '192.168.52.91', '192.168.52.92', '192.168.52.93', '192.168.52.94', '192.168.52.95', '192.168.52.96', '192.168.52.97', '192.168.52.98', '192.168.52.99', '192.168.52.100', '192.168.52.101', '192.168.52.102', '192.168.52.103', '192.168.52.104', '192.168.52.105', '192.168.52.106', '192.168.52.107', '192.168.52.108', '192.168.52.109', '192.168.52.110', '192.168.52.111', '192.168.52.112', '192.168.52.113', '192.168.52.114', '192.168.52.115', '192.168.52.116', '192.168.52.117', '192.168.52.118', '192.168.52.119', '192.168.52.120', '192.168.52.121', '192.168.52.122', '192.168.52.123', '192.168.52.124', '192.168.52.125', '192.168.52.126', '192.168.52.127', '192.168.52.128', '192.168.52.129', '192.168.52.130', '192.168.52.131', '192.168.52.132', '192.168.52.133', '192.168.52.134', '192.168.52.135', '192.168.52.136', '192.168.52.137', '192.168.52.138', '192.168.52.139', '192.168.52.140', '192.168.52.141', '192.168.52.142', '192.168.52.143', '192.168.52.144', '192.168.52.145', '192.168.52.146', '192.168.52.147', '192.168.52.148', '192.168.52.149', '192.168.52.150', '192.168.52.151', '192.168.52.152', '192.168.52.153', '192.168.52.154', '192.168.52.155', '192.168.52.156', '192.168.52.157', '192.168.52.158', '192.168.52.159', '192.168.52.160', '192.168.52.161', '192.168.52.162', '192.168.52.163', '192.168.52.164', '192.168.52.165', '192.168.52.166', '192.168.52.167', '192.168.52.168', '192.168.52.169', '192.168.52.170', '192.168.52.171', '192.168.52.172', '192.168.52.173', '192.168.52.174', '192.168.52.175', '192.168.52.176', '192.168.52.177', '192.168.52.178', '192.168.52.179', '192.168.52.180', '192.168.52.181', '192.168.52.182', '192.168.52.183', '192.168.52.184', '192.168.52.185', '192.168.52.186', '192.168.52.187', '192.168.52.188', '192.168.52.189', '192.168.52.190', '192.168.52.191', '192.168.52.192', '192.168.52.193', '192.168.52.194', '192.168.52.195', '192.168.52.196', '192.168.52.197', '192.168.52.198', '192.168.52.199', '192.168.52.200', '192.168.52.201', '192.168.52.202', '192.168.52.203', '192.168.52.204', '192.168.52.205', '192.168.52.206', '192.168.52.207', '192.168.52.208', '192.168.52.209', '192.168.52.210', '192.168.52.211', '192.168.52.212', '192.168.52.213', '192.168.52.214', '192.168.52.215', '192.168.52.216', '192.168.52.217', '192.168.52.218', '192.168.52.219', '192.168.52.220', '192.168.52.221', '192.168.52.222', '192.168.52.223', '192.168.52.224', '192.168.52.225', '192.168.52.226', '192.168.52.227', '192.168.52.228', '192.168.52.229', '192.168.52.230', '192.168.52.231', '192.168.52.232', '192.168.52.233', '192.168.52.234', '192.168.52.235', '192.168.52.236', '192.168.52.237', '192.168.52.238', '192.168.52.239', '192.168.52.240', '192.168.52.241', '192.168.52.242', '192.168.52.243', '192.168.52.244', '192.168.52.245', '192.168.52.246', '192.168.52.247', '192.168.52.248', '192.168.52.249', '192.168.52.250', '192.168.52.251', '192.168.52.252', '192.168.52.253', '192.168.52.254', '192.168.52.255']
all_ips = ['192.168.2.0', '192.168.2.1', '192.168.2.2', '192.168.2.3', '192.168.2.4', '192.168.2.5', '192.168.2.6', '192.168.2.7', '192.168.2.8', '192.168.2.9', '192.168.2.10', '192.168.2.11', '192.168.2.12', '192.168.2.13', '192.168.2.14', '192.168.2.15', '192.168.2.16', '192.168.2.17', '192.168.2.18', '192.168.2.19', '192.168.2.20', '192.168.2.21', '192.168.2.22', '192.168.2.23', '192.168.2.24', '192.168.2.25', '192.168.2.26', '192.168.2.27', '192.168.2.28', '192.168.2.29', '192.168.2.30', '192.168.2.31', '192.168.2.32', '192.168.2.33', '192.168.2.34', '192.168.2.35', '192.168.2.36', '192.168.2.37', '192.168.2.38', '192.168.2.39', '192.168.2.40', '192.168.2.41', '192.168.2.42', '192.168.2.43', '192.168.2.44', '192.168.2.46', '192.168.2.47', '192.168.2.48', '192.168.2.49', '192.168.2.50', '192.168.2.51', '192.168.2.52', '192.168.2.53', '192.168.2.54', '192.168.2.55', '192.168.2.56', '192.168.2.57', '192.168.2.58', '192.168.2.59', '192.168.2.60', '192.168.2.61', '192.168.2.62', '192.168.2.63', '192.168.2.64', '192.168.2.65', '192.168.2.66', '192.168.2.67', '192.168.2.68', '192.168.2.69', '192.168.2.70', '192.168.2.71', '192.168.2.72', '192.168.2.73', '192.168.2.74', '192.168.2.75', '192.168.2.76', '192.168.2.77', '192.168.2.78', '192.168.2.79', '192.168.2.80', '192.168.2.81', '192.168.2.82', '192.168.2.83', '192.168.2.84', '192.168.2.85', '192.168.2.86', '192.168.2.87', '192.168.2.89', '192.168.2.90', '192.168.2.91', '192.168.2.92', '192.168.2.93', '192.168.2.94', '192.168.2.95', '192.168.2.96', '192.168.2.97', '192.168.2.98', '192.168.2.99', '192.168.2.100', '192.168.2.101', '192.168.2.102', '192.168.2.103', '192.168.2.104', '192.168.2.105', '192.168.2.106', '192.168.2.107', '192.168.2.108', '192.168.2.109', '192.168.2.110', '192.168.2.111', '192.168.2.112', '192.168.2.113', '192.168.2.114', '192.168.2.115', '192.168.2.116', '192.168.2.117', '192.168.2.118', '192.168.2.119', '192.168.2.120', '192.168.2.121', '192.168.2.122', '192.168.2.123', '192.168.2.124', '192.168.2.125', '192.168.2.126', '192.168.2.127', '192.168.2.128', '192.168.2.129', '192.168.2.130', '192.168.2.131', '192.168.2.132', '192.168.2.133', '192.168.2.134', '192.168.2.135', '192.168.2.136', '192.168.2.137', '192.168.2.138', '192.168.2.139', '192.168.2.140', '192.168.2.141', '192.168.2.142', '192.168.2.143', '192.168.2.144', '192.168.2.145', '192.168.2.146', '192.168.2.147', '192.168.2.148', '192.168.2.149', '192.168.2.150', '192.168.2.151', '192.168.2.152', '192.168.2.153', '192.168.2.154', '192.168.2.155', '192.168.2.156', '192.168.2.157', '192.168.2.158', '192.168.2.159', '192.168.2.160', '192.168.2.161', '192.168.2.162', '192.168.2.163', '192.168.2.164', '192.168.2.165', '192.168.2.166', '192.168.2.167', '192.168.2.168', '192.168.2.169', '192.168.2.170', '192.168.2.171', '192.168.2.172', '192.168.2.173', '192.168.2.174', '192.168.2.175', '192.168.2.176', '192.168.2.177', '192.168.2.178', '192.168.2.179', '192.168.2.180', '192.168.2.181', '192.168.2.182', '192.168.2.183', '192.168.2.184', '192.168.2.185', '192.168.2.186', '192.168.2.187', '192.168.2.188', '192.168.2.189', '192.168.2.190', '192.168.2.191', '192.168.2.192', '192.168.2.193', '192.168.2.194', '192.168.2.195', '192.168.2.196', '192.168.2.197', '192.168.2.198', '192.168.2.199', '192.168.2.200', '192.168.2.201', '192.168.2.202', '192.168.2.203', '192.168.2.204', '192.168.2.205', '192.168.2.206', '192.168.2.207', '192.168.2.208', '192.168.2.209', '192.168.2.210', '192.168.2.211', '192.168.2.212', '192.168.2.213', '192.168.2.214', '192.168.2.215', '192.168.2.216', '192.168.2.217', '192.168.2.218', '192.168.2.219', '192.168.2.220', '192.168.2.221', '192.168.2.222', '192.168.2.223', '192.168.2.224', '192.168.2.225', '192.168.2.226', '192.168.2.227', '192.168.2.228', '192.168.2.229', '192.168.2.230', '192.168.2.231', '192.168.2.232', '192.168.2.233', '192.168.2.234', '192.168.2.235', '192.168.2.236', '192.168.2.237', '192.168.2.238', '192.168.2.239', '192.168.2.240', '192.168.2.241', '192.168.2.242', '192.168.2.243', '192.168.2.244', '192.168.2.245', '192.168.2.246', '192.168.2.247', '192.168.2.248', '192.168.2.249', '192.168.2.250', '192.168.2.251', '192.168.2.252', '192.168.2.253', '192.168.2.254', '192.168.2.255']

def worker(main_stream):
	global args
	global all_ips
	cmd = copy.deepcopy(args)
	if main_stream:
		cmd[len(cmd)-1] = cmd[len(cmd)-1].replace('xx','192.168.2.88')
	else:
		cmd[len(cmd)-1] = cmd[len(cmd)-1].replace('xx',all_ips[random.randint(0,len(all_ips)-1)])
	cmd = subprocess.Popen(cmd)

def run_video_streams(num_streams):
	# Start main stream for test
	p = Process(target=worker, args=(True,))
	p.start()

	# Start other parallel streams
	for i in range(num_streams-1):
		p = Process(target=worker, args=(False,))
		p.start()

@app.route('/parallel_streams/<int:num_streams>')
def parallel_streams(num_streams):
	run_video_streams(num_streams)
	return str(1)

if __name__ == '__main__':
	app.run(host='0.0.0.0',port=5000)

